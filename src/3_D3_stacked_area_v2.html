<!DOCTYPE html>
<meta charset="utf-8">
<style>
/* Set basic styling for the page */
body {
  font: 10px avenir;
}

/* Style the axes with black lines */
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

/* Align browser text elements to the end */
.browser text {
  text-anchor: end;
}
</style>
<body>
<script src="https://d3js.org/d3.v3.js"></script>
<script>
  
// Function to select colors for the different categories based on index
function get_colors(n) {
  var colors = ["#a6cee3","#1f78b4","#b2df8a","#33a02c",
                "#fb9a99","#e31a1c","#fdbf6f","#ff7f00",
                "#cab2d6","#6a3d9a"];
  return colors[n % colors.length];
}

// Set margins and dimensions for the chart area
var margin = {top: 61, right: 140, bottom: 101, left: 50},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// Define an array representing 24-hour time labels
var times = ["12am","1a", "2a", "3a", "4a", "5a", "6a",
             "7a", "8a", "9a", "10a", "11a", "12pm", 
             "1p", "2p", "3p", "4p", "5p", "6p", 
             "7p", "8p", "9p", "10p", "11p"];

// Set x and y scale ranges for the chart
var x = d3.scale.linear().range([0, width]);
var y = d3.scale.linear().range([height, 0]);

// Use a color scale for different categories
var color = d3.scale.category10();

// Define the x-axis with a tick interval of 24
var xAxis = d3.svg.axis().scale(x).orient("bottom").ticks(24, "s");

// Define the y-axis with 5 ticks
var yAxis = d3.svg.axis().scale(y).orient("left").ticks(5, "s");

// Define the area function for each stack area segment
var area = d3.svg.area()
    .x(function(d) { return x(d.hour); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); }); 
  
// Set up the stack layout to handle stacking of data
var stack = d3.layout.stack().values(function(d) { return d.values; });

// Append SVG element to the body with specified dimensions
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Add a main title for the chart
svg.append("text")
    .attr("x", 0)
    .attr("y", -40)
    .attr("dy", "0.71em")
    .attr("fill", "#000")
    .text("SFPD Incidents by Hour in Dec 2016")
    .style("font", "23px avenir")
    .style("fill", "#000000");

// Add a description text below the chart
svg.append("text")
    .attr("x", 0)
    .attr("y", 402)
    .attr("dy", "0em")
    .style("font", "12px avenir")
    .style("fill", "#000000")
    .text("This is a plot of the 10 most frequent incidents over a 24-hour period in San Francisco during December 2016.");

// Add additional description text on chart pattern insights
svg.append("text")
    .attr("x", 0)
    .attr("y", 402)
    .attr("dy", "1em")
    .style("font", "12px avenir")
    .style("fill", "#000000")
    .text("Categories follow a structure: occurrences dip early morning and peak during lunch and early evening.");

// Add the author credit text
svg.append("text")
    .attr("x", 0)
    .attr("y", 402)
    .attr("dy", "3em")
    .style("font", "12px avenir")
    .style("fill", "#000000")
    .text("By Anaelia Ovalle")
    .style("font-weight", "bold");

// Load data from CSV file and parse it
d3.csv("data/data_stackedareachart.csv", function(error, data) {
   
    // Set color domain based on data categories
    color.domain(d3.keys(data[0]).filter(function(key) { return key !== "hour"; }));
 
    // Convert data fields to numeric values
    data.forEach(function(d) {  
      d.hour = +d.hour;
      d.burglary = +d.burglary;
      d.assault = +d.assault;
      d.larceny_theft = +d.larceny_theft;
      d.vehicle_related = +d.vehicle_related;
      d.missing_person = +d.missing_person;
      d.non_criminal = +d.non_criminal;
      d.other_offenses = +d.other_offenses;
      d.suspicious_occ = +d.suspicious_occ;
      d.warrants = +d.warrants;
    });

    // Set x and y axis domain ranges based on data
    x.domain(d3.extent(data, function(d) { return d.hour; }));
    y.domain([0, 800]);

    // Stack the data by category
    var browsers = stack(color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {hour: d.hour, y: d[name] * 1};
          })
        };
    }));

    // Create groups for each category and bind data
    var browser = svg.selectAll(".browser")
        .data(browsers)
        .enter().append("g")
        .attr("class", "browser");

    // Draw area for each category with color from get_colors function
    browser.append("path")
        .attr("class", "area")
        .attr("d", function(d) { return area(d.values); })
        .style("fill", function(d,i) { return get_colors(i); });

    // Add x-axis at the bottom of the chart
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis).append("text")
        .attr("x", 350)
        .attr("y", 36)
        .attr("fill", "#000")
        .text("Hour of Time")
        .style("font-weight", "bold");

    // Add y-axis to the left side of the chart
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("x", -250)
        .attr("y", -40)
        .attr("dy", "0.3408em")
        .attr("fill", "#000")
        .text("Number of Incidents")
        .style("font-weight", "bold");
/*

在 SVG 中，`dy` 属性表示“delta-y”，用于相对于其基线垂直调整文本元素的位置。具体来说，它控制文本相对于其默认位置的垂直偏移。

在这个例子中：

```javascript
.attr("dy", "0.3408em")
```

- `"0.3408em"` 将文本稍微向下移动，使其与当前的位置相比有所偏移。`em` 单位是相对于当前字体大小的（1 `em` 等于字体的高度）。
- 使用像 `0.3408em` 这样的小正值，可以进行更精细的调整，确保文本在旋转后视觉上更好地对齐。

因此，在这里，`dy` 帮助更精确地定位 y 轴上的“Number of Incidents”（事件数量）标签。
*/
      
    // Add a legend for each category to the right of the chart
    var legend = svg.selectAll(".legend")
        .data(color.domain()).enter()
        .append("g")
        .attr("class", "legend")
        .attr("transform", "translate(" + (width + 20) + ",0)");

    // Add color box to each legend item
    legend.append("rect")
        .attr("x", 0) 
        .attr("y", function(d, i) { return 20 * i; })
        .attr("width", 10)
        .attr("height", 10)
        .style("fill", function(d, i) { return get_colors(i); });

    // Add category text next to each color box in the legend
    legend.append("text")
        .attr("x", 20) 
        .attr("dy", "0.75em")
        .attr("y", function(d, i) { return 20 * i; })
        .text(function(d) { return d; });

    // Add title "Categories" above the legend
    legend.append("text")
        .attr("x", 0) 
        .attr("y", -10)
        .text("Categories");
});
</script>
